// Update comparison chart - VERSIONE CON GRAFICO CUMULATIVO
function updateComparisonChart(period1, period2, year1, month1, year2, month2) {
    const ctx = document.getElementById('comparisonChart');
    
    if (comparisonChart) {
        comparisonChart.destroy();
    }
    
    const label1 = month1 && month1 !== 'all' ? `${getMonthName(month1)} ${year1}` : year1;
    const label2 = month2 && month2 !== 'all' ? `${getMonthName(month2)} ${year2}` : year2;
    
    if (currentComparisonType === 'category') {
        // Confronto per categoria (rimane uguale)
        const categories = ['Spesa', 'Bollette', 'Affitto', 'Casa', 'Shopping', 'Tempo libero', 'Vacanze', 'Regali'];
        
        const data1 = categories.map(cat => {
            return period1
                .filter(e => e.category === cat && (!e.currency || e.currency === 'EUR'))
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        });
        
        const data2 = categories.map(cat => {
            return period2
                .filter(e => e.category === cat && (!e.currency || e.currency === 'EUR'))
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        });
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: label1,
                        data: data1,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    },
                    {
                        label: label2,
                        data: data2,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: '#ff6384',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: { font: { size: 10 } }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 10 } }
                    },
                    x: {
                        ticks: { 
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    } else {
        // Confronto totali o timeline
        const total1 = period1
            .filter(e => !e.currency || e.currency === 'EUR')
            .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        
        const total2 = period2
            .filter(e => !e.currency || e.currency === 'EUR')
            .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        
        if (currentComparisonType === 'bar') {
            // Grafico a barre (rimane uguale)
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [label1, label2],
                    datasets: [{
                        label: 'Totale Spese',
                        data: [total1, total2],
                        backgroundColor: ['rgba(102, 126, 234, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                        borderColor: ['#667eea', '#ff6384'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        } else {
            // NUOVO: Grafico linee CUMULATIVO
            // Considera solo le categorie attive
            const filterByActiveCategories = (expense) => {
                return activeCategories.has(expense.category) && (!expense.currency || expense.currency === 'EUR');
            };
            
            // Crea oggetti per memorizzare le spese giornaliere
            const dailyExpenses1 = {};
            const dailyExpenses2 = {};
            
            // Accumula le spese per giorno per periodo 1
            period1.filter(filterByActiveCategories).forEach(e => {
                if (e.date && e.date.includes('/')) {
                    const day = parseInt(e.date.split('/')[0]);
                    if (!isNaN(day)) {
                        dailyExpenses1[day] = (dailyExpenses1[day] || 0) + parseFloat(e.amount || 0);
                    }
                }
            });
            
            // Accumula le spese per giorno per periodo 2
            period2.filter(filterByActiveCategories).forEach(e => {
                if (e.date && e.date.includes('/')) {
                    const day = parseInt(e.date.split('/')[0]);
                    if (!isNaN(day)) {
                        dailyExpenses2[day] = (dailyExpenses2[day] || 0) + parseFloat(e.amount || 0);
                    }
                }
            });
            
            // Determina il range di giorni (1-31 per mesi completi)
            const maxDay = Math.max(
                ...Object.keys(dailyExpenses1).map(d => parseInt(d)),
                ...Object.keys(dailyExpenses2).map(d => parseInt(d)),
                31 // Assicura almeno 31 giorni per mesi completi
            );
            
            // Crea array di tutti i giorni
            const allDays = [];
            for (let i = 1; i <= maxDay; i++) {
                allDays.push(i);
            }
            
            // Calcola i valori cumulativi
            let cumulative1 = 0;
            let cumulative2 = 0;
            
            const cumulativeData1 = allDays.map(day => {
                cumulative1 += dailyExpenses1[day] || 0;
                return cumulative1;
            });
            
            const cumulativeData2 = allDays.map(day => {
                cumulative2 += dailyExpenses2[day] || 0;
                return cumulative2;
            });
            
            // Crea le etichette per i giorni
            const dayLabels = allDays.map(d => `Giorno ${d}`);
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: [
                        {
                            label: label1 + ' (cumulativo)',
                            data: cumulativeData1,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.1,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: label2 + ' (cumulativo)',
                            data: cumulativeData2,
                            borderColor: '#ff6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    const dayIndex = context.dataIndex;
                                    
                                    // Calcola la spesa del giorno specifico
                                    let dailyAmount = 0;
                                    if (context.datasetIndex === 0) {
                                        // Periodo 1
                                        dailyAmount = dailyExpenses1[dayIndex + 1] || 0;
                                    } else {
                                        // Periodo 2
                                        dailyAmount = dailyExpenses2[dayIndex + 1] || 0;
                                    }
                                    
                                    return [
                                        `${label}: €${value.toFixed(2)}`,
                                        `Spese del giorno: €${dailyAmount.toFixed(2)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { size: 10 },
                                callback: function(value) {
                                    return '€' + value.toFixed(0);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Totale Cumulativo (€)',
                                font: { size: 11 }
                            }
                        },
                        x: {
                            ticks: { 
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                callback: function(value, index) {
                                    // Mostra solo alcuni giorni per evitare sovrapposizioni
                                    if (index === 0 || (index + 1) % 5 === 0 || index === this.getLabelForValue(value).length - 1) {
                                        return this.getLabelForValue(value);
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
}
